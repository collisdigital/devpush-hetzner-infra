#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - git

users:
  # SSH login user - use this account to access the server
  - name: ${ssh_login_username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}
  # Devpush service account - system user with no login capability
  - name: ${devpush_service_username}
    system: true
    shell: /usr/sbin/nologin
    no_create_home: false
    homedir: /opt/devpush

write_files:
  - path: /etc/ssh/sshd_config.d/99-disable-root-login.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
    permissions: '0644'
  - path: /etc/opt/devpush/.env.custom
    content: |     
      APP_HOSTNAME="devpush.${domain_name}"
      DEPLOY_DOMAIN="${domain_name}"
      LE_EMAIL="admin@${domain_name}"
      CERT_CHALLENGE_PROVIDER="cloudflare"
      CF_DNS_API_TOKEN="${devpush_cloudflare_api_token}"
      
      GITHUB_APP_ID="${devpush_github_app_id}"
      GITHUB_APP_NAME="${devpush_github_app_name}"
      GITHUB_APP_PRIVATE_KEY="${devpush_github_app_private_key}"
      GITHUB_APP_WEBHOOK_SECRET="${devpush_github_app_webhook_secret}"
      GITHUB_APP_CLIENT_ID="${devpush_github_app_client_id}"
      GITHUB_APP_CLIENT_SECRET="${devpush_github_app_client_secret}"
      
      # Email
      EMAIL_SENDER_ADDRESS="${devpush_service_username}@${domain_name}"
      RESEND_API_KEY="${devpush_resend_api_key}"
    permissions: '0600'
  - path: /usr/local/bin/merge-env.sh
    content: |
      ${indent(6, merge_env_script)}
    permissions: '0755'

runcmd:
  # Restart SSH to apply configuration changes
  - systemctl restart ssh

  # Prepare and mount the Hetzner volume to a standard location
  - mkdir -p /mnt/devpush-volume
  - |
    # Wait for the volume to be attached (up to 60 seconds)
    for i in $(seq 1 12); do
      if [ -b /dev/disk/by-id/scsi-0HC_Volume_* ]; then
        break
      fi
      sleep 5
    done
  
  # Mount the Hetzner volume to /mnt/devpush-volume
  - |
    # Get the volume device path
    VOLUME_DEV=$(ls /dev/disk/by-id/scsi-0HC_Volume_* 2>/dev/null | head -1)
    if [ -n "$VOLUME_DEV" ]; then
      # Check if already has a filesystem, if not format it
      if ! blkid "$VOLUME_DEV" | grep -q 'TYPE='; then
        mkfs.ext4 -F "$VOLUME_DEV"
      fi
      # Add to fstab if not already present
      if ! grep -q '/mnt/devpush-volume' /etc/fstab; then
        echo "$VOLUME_DEV /mnt/devpush-volume ext4 defaults,nofail 0 2" >> /etc/fstab
      fi
      # Mount the volume
      mount /mnt/devpush-volume

      # Allow others to 'traverse' the mount point
      chmod o+x /mnt/devpush-volume
    fi
  
  # Create the devpush root folder structure on the volume with unique names
  - | 
    mkdir -p /mnt/devpush-volume/devpush/opt
    mkdir -p /mnt/devpush-volume/devpush/var-lib
    mkdir -p /mnt/devpush-volume/devpush/var-backups
    chown -R ${devpush_service_username}:${devpush_service_username} /mnt/devpush-volume/devpush
    chmod 0750 /mnt/devpush-volume/devpush
  
  # Create parent directories and symlinks for devpush directories
  - |
    mkdir -p /opt /var/lib /var/backups
    ln -sfn /mnt/devpush-volume/devpush/opt /opt/devpush
    ln -sfn /mnt/devpush-volume/devpush/var-lib /var/lib/devpush
    ln -sfn /mnt/devpush-volume/devpush/var-backups /var/backups/devpush
  
  # Install Devpush (retry up to 5 times with 30 second sleep between retries)
  - |
    for attempt in $(seq 1 5); do
      echo "Devpush install attempt $attempt of 5..."
      if curl -fsSL https://install.devpu.sh | sudo bash -s -- --verbose --yes; then
        echo "Devpush installed successfully on attempt $attempt"
        break
      fi
      if [ "$attempt" -lt 5 ]; then
        echo "Devpush install failed, retrying in 30 seconds..."
        sleep 30
      else
        echo "Devpush install failed after 5 attempts"
        exit 1
      fi
    done

  # Merge environment variables and restart the Devpush service
  - echo "Merging custom environment variables into Devpush configuration..."
  - /usr/local/bin/merge-env.sh

  - echo "Reloading systemd daemon configuration..."
  - systemctl daemon-reload

  - echo "Enabling and starting the Devpush service (waiting up to 30 seconds)..."
  - timeout 30s bash -c 'until systemctl enable --now devpush.service; do sleep 5; done'

  - echo "Checking Devpush service status..."
  - systemctl status devpush.service

  # Install Cloudflare Tunnel Agent
  - echo "Installing Cloudflared..."

  - echo "Adding Cloudflare GPG key..."
  - sudo mkdir -p --mode=0755 /usr/share/keyrings
  - curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null

  - echo "Adding Cloudflare repository..."
  - echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared noble main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
  
  - echo "Updating package lists and installing cloudflared..."
  - sudo apt-get update && sudo apt-get install cloudflared
  - cloudflared --version
  
  - echo "Configuring Cloudflared Tunnel..."
  - cloudflared service install --no-update-service ${tunnel_token}

  - echo "Starting Cloudflared Tunnel..."
  - systemctl enable --now cloudflared
  - systemctl status cloudflared