#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - curl
  - git

users:
  - name: devpush
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}

write_files:
  - path: /etc/ssh/sshd_config.d/99-disable-root-login.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
    permissions: '0644'
  - path: /etc/opt/devpush/.env.custom
    content: |     
      APP_HOSTNAME=devpush.${domain_name}
      DEPLOY_DOMAIN=${domain_name}
      LE_EMAIL=admin@${domain_name}
      CERT_CHALLENGE_PROVIDER=cloudflare
      CF_DNS_API_TOKEN=${devpush_cloudflare_api_token}
      
      GITHUB_APP_ID=${devpush_github_app_id}
      GITHUB_APP_NAME=${devpush_github_app_name}
      GITHUB_APP_PRIVATE_KEY='${devpush_github_app_private_key}'
      GITHUB_APP_WEBHOOK_SECRET=${devpush_github_app_webhook_secret}
      GITHUB_APP_CLIENT_ID=${devpush_github_app_client_id}
      GITHUB_APP_CLIENT_SECRET=${devpush_github_app_client_secret}
      
      # Email
      EMAIL_SENDER_ADDRESS=devpush@${domain_name}
      RESEND_API_KEY=${devpush_resend_api_key}
    permissions: '0600'
  - path: /usr/local/bin/merge-env.sh
    content: |
      ${indent(6, merge_env_script)}
    permissions: '0755'

runcmd:
  - systemctl restart ssh
  # Prepare and mount the Hetzner volume
  - mkdir -p /var/lib/devpush
  - |
    # Wait for the volume to be attached (up to 60 seconds)
    for i in $(seq 1 12); do
      if [ -b /dev/disk/by-id/scsi-0HC_Volume_* ]; then
        break
      fi
      sleep 5
    done
  - |
    # Get the volume device path
    VOLUME_DEV=$(ls /dev/disk/by-id/scsi-0HC_Volume_* 2>/dev/null | head -1)
    if [ -n "$VOLUME_DEV" ]; then
      # Check if already has a filesystem, if not format it
      if ! blkid "$VOLUME_DEV" | grep -q 'TYPE='; then
        mkfs.ext4 -F "$VOLUME_DEV"
      fi
      # Add to fstab if not already present
      if ! grep -q '/var/lib/devpush' /etc/fstab; then
        echo "$VOLUME_DEV /var/lib/devpush ext4 defaults,nofail 0 2" >> /etc/fstab
      fi
      # Mount the volume
      mount /var/lib/devpush
    fi
  - chown -R devpush:devpush /var/lib/devpush
  - chmod 0750 /var/lib/devpush
  - mkdir -p /opt/devpush
  - chown -R devpush:devpush /opt/devpush
  - chmod 0750 /opt/devpush
  - curl -fsSL https://install.devpu.sh | sudo bash -s -- --verbose --yes
  - /usr/local/bin/merge-env.sh
  - systemctl daemon-reload
  # Wait up to 30 seconds for the service file to actually exist before enabling
  - timeout 30s bash -c 'until systemctl enable --now devpush.service; do sleep 5; done'
  - systemctl status devpush.service